<h1 id="-migrate-applications-to-tee">üêù Migrate Applications to TEE</h1>

<p>This section will not cover how to containerize your application with Docker. Instead, we assume you have already done so and have tested it locally to ensure all functionalities work well. Our focus here is to demonstrate how to migrate your application into a TEE, ensuring it remains accessible and providing TEE Proof so you can verify its integrity to anyone interested.</p>

<h3 id="expose-service-port">Expose Service Port</h3>

<p>In Docker, you can specify the <strong>HTTP ports</strong> you want to expose by <a href="https://docs.docker.com/get-started/docker-concepts/running-containers/publishing-ports/#publishing-ports"><strong>configuring port publishing</strong></a> using the format <strong>HOST_PORT:CONTAINER_PORT</strong>. This configuration forwards requests sent to <strong>HOST_PORT</strong> to the container‚Äôs program listening on <strong>CONTAINER_PORT</strong>.</p>

<p>When deploying your Docker program to Phala TEE Cloud, the process remains the same. You should specify the port mapping in the Docker Compose file using the <strong>ports</strong> field, as shown below:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">80:8000"</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgres</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8001:5432"</span>
</code></pre></div></div>

<p>After deployment, you will see two public endpoints on the dashboard. These URLs can be used to publicly access the service running in Docker. Behind the scenes, our cloud platform parses the Docker Compose file and automatically configures the network forwarding.</p>

<p><img src="/phala-cloud-community/imgs/network-page.png" alt="network-page" /></p>

<p><strong>üéâ Congratulations! You‚Äôve successfully deployed your application into a TEE. If you‚Äôre interested in learning more, such as how to prove your application‚Äôs integrity to others or manage application logs, keep reading.</strong></p>

<h3 id="generate-ra-report-inside-the-container">Generate RA Report Inside the Container</h3>

<p>The cloud will generate a default RA report for your application when it is bootstrapped. You can view this report on the dashboard under the <strong>Attestation</strong> tab and verify it by clicking the <strong>Check</strong> <strong>Attestation</strong> button.</p>

<p><img src="/phala-cloud-community/imgs/cert-chain.png" alt="cert-chain" /></p>

<p>To generate a new RA report, rather than using the default one, which allows you to prove the execution of your code, you first need to mount the Dstack API socket file to the container by configuring <strong>volumes</strong> in the Docker Compose file.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">quay.io/jupyter/base-notebook</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/var/run/tappd.sock:/var/run/tappd.sock</span>
</code></pre></div></div>

<p>In your application, you can generate the RA report using the <a href="https://github.com/Dstack-TEE/dstack/tree/master/sdk">Dstack guest SDK</a>, which supports Python, JS, and Go. The <code class="language-plaintext highlighter-rouge">user-data</code> field allows you to attach your own data to the RA report. In practice, this is a method to bind the RA report to your application. For example, you can generate a key pair and include the public key. This way, others can verify that the RA report was indeed generated by your program by checking the signature with the public key, after the RA quote itself has been verified.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">dstack_sdk</span> <span class="kn">import</span> <span class="n">TappdClient</span>

<span class="c1"># Initialize the client
</span><span class="n">client</span> <span class="o">=</span> <span class="nc">TappdClient</span><span class="p">()</span>

<span class="c1"># Get quote for a message
</span><span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">tdx_quote</span><span class="p">(</span><span class="sh">'</span><span class="s">user-data</span><span class="sh">'</span><span class="p">)</span>
<span class="n">quote</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">quote</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="access-database">Access Database</h3>

<p>Phala TEE Cloud supports running a database locally or connecting to an external database. There is no difference in how you access a database compared to a general server. To save your data to disk, <strong>you need to <a href="https://docs.docker.com/reference/compose-file/volumes/">configure volumes</a> in the Docker Compose file</strong> and write data to the correct path, here is an example from Docker website.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">backend</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">example/database</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">db-data:/etc/data</span>

  <span class="na">backup</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">backup-service</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">db-data:/var/lib/backup/data</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">db-data</span><span class="pi">:</span>
</code></pre></div></div>

<h3 id="create-crypto-wallet">Create Crypto Wallet</h3>

<p>You can derive a deterministic key using the <a href="https://github.com/Dstack-TEE/dstack/tree/master/sdk">Dstack Guest SDK</a> inside Docker. Under the hood, the <code class="language-plaintext highlighter-rouge">TappdClient</code> derives the key from the application root key.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">dstack_sdk</span> <span class="kn">import</span> <span class="n">TappdClient</span>

<span class="c1"># Initialize the client
</span><span class="n">client</span> <span class="o">=</span> <span class="nc">TappdClient</span><span class="p">()</span>

<span class="c1"># Derive Key Account by given **derive** **path** and **alt names**
</span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">derive_key</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">alt names</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>
